<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartJFB - 比赛管理</title>
  <link rel="stylesheet" href="../css/components.css">
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <script src="http://localhost:3000/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="app">
    <div class="dashboard">
      <header class="dashboard-header">
        <div class="header-content">
          <div class="header-left">
            <a href="../nav.html" class="btn btn-secondary">返回导航</a>
            <h1>比赛管理系统</h1>
          </div>
          <div class="status-bar">
            <span id="connection-status" class="status-indicator">未连接</span>
            <span id="game-status" class="status-indicator">就绪</span>
          </div>
        </div>
      </header>

      <div class="dashboard-main">
        <section id="active-games-section" class="card">
          <div class="section-header">
            <h2>当前比赛</h2>
            <div class="management-controls">
              <button id="refresh-games" class="btn btn-info">刷新列表</button>
              <button id="create-new-game" class="btn btn-primary">创建新比赛</button>
            </div>
          </div>
          <div class="form-container">
            <div class="form-row">
              <div class="form-group">
                <label for="sport-filter">运动类型:</label>
                <select id="sport-filter" class="form-control">
                  <option value="">全部</option>
                  <option value="basketball">篮球</option>
                  <option value="soccer">足球</option>
                </select>
              </div>
              <div class="form-group">
                <label for="status-filter">比赛状态:</label>
                <select id="status-filter" class="form-control">
                  <option value="">全部</option>
                  <option value="active">进行中</option>
                  <option value="completed">已完成</option>
                  <option value="scheduled">已安排</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group full-width">
                <label for="active-games">选择比赛:</label>
                <select id="active-games" class="form-control">
                  <option value="">请选择比赛...</option>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button id="view-game" class="btn btn-primary btn-large">查看比赛</button>
              <button id="manage-game" class="btn btn-info btn-large">管理比赛</button>
              <button id="delete-game" class="btn btn-danger btn-large">删除比赛</button>
            </div>
          </div>
        </section>

        <section id="game-details-section" class="card">
          <h2>比赛详情</h2>
          <div class="form-container">
            <div class="form-row">
              <div class="form-group">
                <label for="game-sport">运动类型:</label>
                <input type="text" id="game-sport" class="form-control" readonly>
              </div>
              <div class="form-group">
                <label for="game-status">比赛状态:</label>
                <input type="text" id="game-status" class="form-control" readonly>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="home-team-display">主队:</label>
                <input type="text" id="home-team-display" class="form-control" readonly>
              </div>
              <div class="form-group">
                <label for="away-team-display">客队:</label>
                <input type="text" id="away-team-display" class="form-control" readonly>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="created-at">创建时间:</label>
                <input type="text" id="created-at" class="form-control" readonly>
              </div>
              <div class="form-group">
                <label for="last-updated">最后更新:</label>
                <input type="text" id="last-updated" class="form-control" readonly>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script src="../js/utils.js"></script>
  <script src="../js/main.js"></script>
  <script>
    // 检查认证状态，如果没有认证则重定向到登录页面
    document.addEventListener('DOMContentLoaded', function() {
// 延迟检查认证，确保utils.js完全加载
      setTimeout(function() {
        if (!window.isAuthenticated || !window.isAuthenticated()) {
          // 如果未认证，则使用requireAuth进行重定向
          if (window.requireAuth) {
            window.requireAuth('./auth.html');
          } else {
            // 如果requireAuth不可用，直接跳转
            window.location.href = './auth.html';
          }
        }
      }, 100);
      initGameManagementPage();
    });

    async function initGameManagementPage() {
      // 初始化事件处理器
      document.getElementById('create-new-game')?.addEventListener('click', showCreateGameModal);
      document.getElementById('refresh-games')?.addEventListener('click', refreshGamesList);
      document.getElementById('view-game')?.addEventListener('click', viewSelectedGame);
      document.getElementById('manage-game')?.addEventListener('click', manageSelectedGame);
      document.getElementById('delete-game')?.addEventListener('click', deleteSelectedGame);

      // 更新连接状态
      checkConnectionStatus();
      
      // 初始化游戏列表
      await refreshGamesList();
    }

    // 显示创建比赛模态框
    function showCreateGameModal() {
      window.location.href = 'create_new_game.html';
    }

    // 查看选中比赛
    async function viewSelectedGame() {
      const gameId = document.getElementById('active-games').value;
      
      if (!gameId) {
        alert('请选择一个比赛');
        return;
      }
      
      // 可以在这里打开新窗口查看比赛详情或重定向到计分页面
      alert(`正在查看比赛: ${gameId}`);
    }

    // 管理选中比赛
    async function manageSelectedGame() {
      const gameId = document.getElementById('active-games').value;
      
      if (!gameId) {
        alert('请选择一个比赛');
        return;
      }
      
      // 重定向到比赛管理页面
      window.location.href = `scoring.html?gameId=${encodeURIComponent(gameId)}`;
    }

    // 删除选中比赛
    async function deleteSelectedGame() {
      const gameId = document.getElementById('active-games').value;
      
      if (!gameId) {
        alert('请选择一个比赛');
        return;
      }
      
      if (!confirm('确定要删除这个比赛吗？此操作不可撤销。')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/games/${gameId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('比赛删除成功');
          await refreshGamesList();
        } else {
          throw new Error(result.error || '删除比赛失败');
        }
      } catch (error) {
        console.error('Error deleting game:', error);
        alert(`删除比赛失败: ${error.message}`);
      }
    }

    // 刷新比赛列表
    async function refreshGamesList() {
      try {
        const response = await fetch(`${API_BASE_URL}/games`);
        const data = await response.json();
        
        if (response.ok) {
          updateGamesList(data.games || []);
        } else {
          throw new Error(data.error || '刷新比赛列表失败');
        }
      } catch (error) {
        console.error('Error refreshing games list:', error);
        alert(`刷新比赛列表失败: ${error.message}`);
      }
    }

    // 更新比赛列表
    function updateGamesList(games) {
      const gameSelect = document.getElementById('active-games');
      const sportFilter = document.getElementById('sport-filter').value;
      const statusFilter = document.getElementById('status-filter').value;
      
      // 清空现有选项
      gameSelect.innerHTML = '<option value="">请选择比赛...</option>';
      
      // 应用过滤器并添加游戏选项
      games
        .filter(game => {
          // 按运动类型过滤
          if (sportFilter && game.sport !== sportFilter) return false;
          // 按状态过滤
          if (statusFilter && game.status !== statusFilter) return false;
          return true;
        })
        .forEach(game => {
          const option = document.createElement('option');
          option.value = game.id;
          option.textContent = `${Array.isArray(game.teams) && game.teams[0]?.name || 'Home'} vs ${Array.isArray(game.teams) && game.teams[1]?.name || 'Away'} (${game.sport})`;
          gameSelect.appendChild(option);
        });
    }

    // 监听游戏选择变化
    document.getElementById('active-games')?.addEventListener('change', async function() {
      const gameId = this.value;
      if (gameId) {
        await loadGameDetails(gameId);
      }
    });

    // 监听过滤器变化
    document.getElementById('sport-filter')?.addEventListener('change', refreshGamesList);
    document.getElementById('status-filter')?.addEventListener('change', refreshGamesList);

    // 加载游戏详情
    async function loadGameDetails(gameId) {
      try {
        const response = await fetch(`${API_BASE_URL}/games/${gameId}`);
        const game = await response.json();
        
        if (response.ok) {
          document.getElementById('game-sport').value = game.sport === 'basketball' ? '篮球' : '足球';
          document.getElementById('game-status').value = getGameStatusText(game.status);
          document.getElementById('home-team-display').value = Array.isArray(game.teams) && game.teams[0]?.name || 'N/A';
          document.getElementById('away-team-display').value = Array.isArray(game.teams) && game.teams[1]?.name || 'N/A';
          document.getElementById('created-at').value = formatDate(new Date(game.createdAt));
          document.getElementById('last-updated').value = formatDate(new Date(game.updatedAt));
        } else {
          throw new Error(game.error || '加载比赛详情失败');
        }
      } catch (error) {
        console.error('Error loading game details:', error);
        alert(`加载比赛详情失败: ${error.message}`);
      }
    }

    // 获取游戏状态文本
    function getGameStatusText(status) {
      const statusMap = {
        'scheduled': '已安排',
        'active': '进行中',
        'completed': '已完成',
        'paused': '已暂停'
      };
      return statusMap[status] || status;
    }

    // 格式化日期
    function formatDate(date) {
      return date.toLocaleString('zh-CN');
    }

    // 初始化页面
    async function initGameManagementPage() {
      // 初始化事件处理器
      document.getElementById('create-new-game')?.addEventListener('click', showCreateGameModal);
      document.getElementById('refresh-games')?.addEventListener('click', refreshGamesList);
      document.getElementById('view-game')?.addEventListener('click', viewSelectedGame);
      document.getElementById('manage-game')?.addEventListener('click', manageSelectedGame);
      document.getElementById('delete-game')?.addEventListener('click', deleteSelectedGame);

      // 更新连接状态
      checkConnectionStatus();
      
      // 初始化游戏列表
      await refreshGamesList();
    }
  </script>
</body>
</html>