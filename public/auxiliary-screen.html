<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>辅助信息屏 - SmartJFB</title>
    <link rel="stylesheet" href="/css/auxiliary-screen.css">
</head>
<body>
    <div class="auxiliary-screen">
        <div class="header">
            <h1>辅助信息屏</h1>
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot"></span>
                <span class="status-text">已连接</span>
            </div>
            <button onclick="window.location.href='/'" class="btn-back">返回主页</button>
        </div>

        <div class="main-content">
            <!-- 比赛信息 -->
            <div class="section">
                <h2>比赛信息</h2>
                <div class="match-info">
                    <div class="info-row">
                        <span class="label">比赛类型:</span>
                        <span id="matchType">篮球</span>
                    </div>
                    <div class="info-row">
                        <span class="label">比赛状态:</span>
                        <span id="matchStatus">未开始</span>
                    </div>
                    <div class="info-row">
                        <span class="label">当前节次:</span>
                        <span>第 <span id="currentPeriod">1</span> 节</span>
                    </div>
                </div>
            </div>

            <!-- 球队阵容 -->
            <div class="section">
                <h2>主队阵容</h2>
                <div class="roster" id="homeRoster">
                    <div class="no-roster">暂无球员</div>
                </div>
            </div>

            <div class="section">
                <h2>客队阵容</h2>
                <div class="roster" id="awayRoster">
                    <div class="no-roster">暂无球员</div>
                </div>
            </div>

            <!-- 球员数据 -->
            <div class="section">
                <h2>球员数据</h2>
                <div class="player-stats" id="playerStats">
                    <div class="no-data">暂无数据</div>
                </div>
            </div>

            <!-- 广告位 -->
            <div class="section">
                <h2>赞助商</h2>
                <div class="ads-container" id="adsContainer">
                    <div class="ad-item">
                        <span>赞助商位置</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/socket-client.js"></script>
    <script>
        // 初始化Socket连接
        const socket = initSocket('auxiliary');

        // 监听初始数据
        socket.on('initial_data', (data) => {
            updateAuxiliary(data);
        });

        // 监听数据更新
        socket.on('update', (data) => {
            if (data.matchInfo) {
                updateAuxiliary(data.matchInfo);
            }
        });

        // 更新辅助信息屏
        function updateAuxiliary(data) {
            if (!data) return;

            // 更新比赛信息
            if (data.sportType) {
                const typeMap = {
                    'basketball': '篮球',
                    'football': '足球'
                };
                document.getElementById('matchType').textContent = typeMap[data.sportType] || '未知';
            }

            if (data.status) {
                const statusMap = {
                    'not_started': '未开始',
                    'in_progress': '进行中',
                    'paused': '暂停',
                    'completed': '已结束'
                };
                document.getElementById('matchStatus').textContent = statusMap[data.status] || '未知';
            }

            if (data.currentPeriod !== undefined) {
                document.getElementById('currentPeriod').textContent = data.currentPeriod + 1;
            }

            // 更新主队阵容
            if (data.homeTeam && data.homeTeam.players) {
                displayRoster('homeRoster', data.homeTeam.players, 'home');
            }

            // 更新客队阵容
            if (data.awayTeam && data.awayTeam.players) {
                displayRoster('awayRoster', data.awayTeam.players, 'away');
            }

            // 更新球员数据
            updatePlayerStats(data);
        }

        // 显示阵容
        function displayRoster(containerId, players, team) {
            const container = document.getElementById(containerId);
            if (!players || players.length === 0) {
                container.innerHTML = '<div class="no-roster">暂无球员</div>';
                return;
            }

            container.innerHTML = players.map(player => `
                <div class="player-item">
                    <div class="player-number">#${player.number || '-'}</div>
                    <div class="player-name">${player.name || '未知'}</div>
                    <div class="player-stats-mini">
                        <span>${player.statistics?.points || 0}分</span>
                        <span>${player.statistics?.fouls || 0}犯规</span>
                    </div>
                </div>
            `).join('');
        }

        // 更新球员数据
        function updatePlayerStats(data) {
            const container = document.getElementById('playerStats');
            const allPlayers = [
                ...(data.homeTeam?.players || []).map(p => ({ ...p, team: 'home' })),
                ...(data.awayTeam?.players || []).map(p => ({ ...p, team: 'away' }))
            ];

            if (allPlayers.length === 0) {
                container.innerHTML = '<div class="no-data">暂无数据</div>';
                return;
            }

            // 按得分排序
            const sortedPlayers = allPlayers.sort((a, b) =>
                (b.statistics?.points || 0) - (a.statistics?.points || 0)
            ).slice(0, 5);

            container.innerHTML = sortedPlayers.map(player => {
                const teamClass = player.team === 'home' ? 'home' : 'away';
                const teamName = player.team === 'home' ? '主队' : '客队';
                return `
                    <div class="player-stat-item">
                        <div class="player-info">
                            <span class="player-name">${player.name || '未知'}</span>
                            <span class="player-team badge ${teamClass}">${teamName}</span>
                            <span class="player-number">#${player.number || '-'}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">得分:</span>
                            <span class="stat-value">${player.statistics?.points || 0}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">犯规:</span>
                            <span class="stat-value">${player.statistics?.fouls || 0}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 加载广告
        async function loadAds() {
            try {
                const response = await fetch('/api/ads/enabled');
                const data = await response.json();
                if (data.success && data.data) {
                    displayAds(data.data);
                }
            } catch (error) {
                console.error('加载广告失败:', error);
            }
        }

        function displayAds(ads) {
            const container = document.getElementById('adsContainer');
            if (!ads || ads.length === 0) {
                container.innerHTML = '<div class="ad-item"><span>暂无广告</span></div>';
                return;
            }

            container.innerHTML = ads.map(ad => `
                <div class="ad-item">
                    ${ad.type === 'image' ? `<img src="${ad.content}" alt="${ad.title}">` :
                      ad.type === 'video' ? `<video src="${ad.content}" muted loop></video>` :
                      `<span>${ad.content}</span>`}
                </div>
            `).join('');
        }

        // 初始化
        loadAds();
    </script>
</body>
</html>
