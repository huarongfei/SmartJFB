<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计面板 - SmartJFB</title>
    <link rel="stylesheet" href="/css/statistics.css">
</head>
<body>
    <div class="statistics-panel">
        <div class="header">
            <h1>实时统计面板</h1>
            <div class="connection-status" id="connectionStatus">
                <span class="status-dot"></span>
                <span class="status-text">已连接</span>
            </div>
            <button onclick="window.location.href='/'" class="btn-back">返回主页</button>
        </div>

        <div class="main-content">
            <!-- 比分概览 -->
            <div class="section">
                <h2>比分概览</h2>
                <div class="score-overview">
                    <div class="team-overview home">
                        <h3>主队</h3>
                        <div class="score" id="homeTeamScore">0</div>
                    </div>
                    <div class="vs">VS</div>
                    <div class="team-overview away">
                        <h3>客队</h3>
                        <div class="score" id="awayTeamScore">0</div>
                    </div>
                </div>
            </div>

            <!-- 队伍统计对比 -->
            <div class="section">
                <h2>队伍统计对比</h2>
                <div class="team-comparison">
                    <div class="stat-item">
                        <div class="stat-name">得分</div>
                        <div class="stat-bar">
                            <div class="bar home" id="homePointsBar"></div>
                            <div class="value home" id="homePoints">0</div>
                            <div class="bar away" id="awayPointsBar"></div>
                            <div class="value away" id="awayPoints">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">犯规</div>
                        <div class="stat-bar">
                            <div class="bar home" id="homeFoulsBar"></div>
                            <div class="value home" id="homeFouls">0</div>
                            <div class="bar away" id="awayFoulsBar"></div>
                            <div class="value away" id="awayFouls">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">命中数</div>
                        <div class="stat-bar">
                            <div class="bar home" id="homeShotsMadeBar"></div>
                            <div class="value home" id="homeShotsMade">0</div>
                            <div class="bar away" id="awayShotsMadeBar"></div>
                            <div class="value away" id="awayShotsMade">0</div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">投篮数</div>
                        <div class="stat-bar">
                            <div class="bar home" id="homeShotsAttemptsBar"></div>
                            <div class="value home" id="homeShotsAttempts">0</div>
                            <div class="bar away" id="awayShotsAttemptsBar"></div>
                            <div class="value away" id="awayShotsAttempts">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 球员排行榜 -->
            <div class="section">
                <h2>球员排行榜</h2>
                <div class="leaderboard-tabs">
                    <button class="tab active" data-type="points">得分</button>
                    <button class="tab" data-type="fouls">犯规</button>
                    <button class="tab" data-type="shots">投篮</button>
                </div>
                <div class="leaderboard" id="leaderboard">
                    <div class="no-data">暂无数据</div>
                </div>
            </div>

            <!-- 比赛事件统计 -->
            <div class="section">
                <h2>比赛事件统计</h2>
                <div class="event-stats">
                    <div class="event-stat-item">
                        <div class="stat-label">总事件数</div>
                        <div class="stat-value" id="totalEvents">0</div>
                    </div>
                    <div class="event-stat-item">
                        <div class="stat-label">得分事件</div>
                        <div class="stat-value" id="scoreEvents">0</div>
                    </div>
                    <div class="event-stat-item">
                        <div class="stat-label">犯规事件</div>
                        <div class="stat-value" id="foulEvents">0</div>
                    </div>
                    <div class="event-stat-item">
                        <div class="stat-label">其他事件</div>
                        <div class="stat-value" id="otherEvents">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/socket-client.js"></script>
    <script>
        // 初始化Socket连接
        const socket = initSocket('statistics');
        let currentTab = 'points';

        // 监听初始数据
        socket.on('initial_data', (data) => {
            updateStatistics(data);
        });

        // 监听数据更新
        socket.on('data_update', (data) => {
            if (data.matchInfo) {
                updateStatistics(data.matchInfo);
            }
        });

        // 标签切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.type;
                updateLeaderboard();
            });
        });

        // 更新统计
        function updateStatistics(data) {
            if (!data) return;

            // 更新比分
            if (data.homeTeam) {
                const homeScore = parseInt(data.homeTeam.score) || 0;
                document.getElementById('homeTeamScore').textContent = homeScore;
                document.getElementById('homePoints').textContent = homeScore;
                const homeFouls = parseInt(data.homeTeam.fouls) || 0;
                document.getElementById('homeFouls').textContent = homeFouls;
                const made = data.homeTeam.statistics?.shots?.made || 0;
                const attempts = data.homeTeam.statistics?.shots?.attempts || 0;
                document.getElementById('homeShotsMade').textContent = made;
                document.getElementById('homeShotsAttempts').textContent = attempts;
            }

            if (data.awayTeam) {
                const awayScore = parseInt(data.awayTeam.score) || 0;
                document.getElementById('awayTeamScore').textContent = awayScore;
                document.getElementById('awayPoints').textContent = awayScore;
                const awayFouls = parseInt(data.awayTeam.fouls) || 0;
                document.getElementById('awayFouls').textContent = awayFouls;
                const made = data.awayTeam.statistics?.shots?.made || 0;
                const attempts = data.awayTeam.statistics?.shots?.attempts || 0;
                document.getElementById('awayShotsMade').textContent = made;
                document.getElementById('awayShotsAttempts').textContent = attempts;
            }

            // 更新统计条
            updateStatBars(data);

            // 更新事件统计
            if (data.events) {
                updateEventStats(data.events);
            }

            // 更新排行榜
            updateLeaderboard();
        }

        // 更新统计条
        function updateStatBars(data) {
            const maxPoints = Math.max(
                data.homeTeam?.score || 0,
                data.awayTeam?.score || 0,
                1
            );
            const maxFouls = Math.max(
                data.homeTeam?.fouls || 0,
                data.awayTeam?.fouls || 0,
                1
            );
            const maxShots = Math.max(
                data.homeTeam?.statistics?.shots?.attempts || 0,
                data.awayTeam?.statistics?.shots?.attempts || 0,
                1
            );

            if (data.homeTeam) {
                document.getElementById('homePointsBar').style.width =
                    `${(data.homeTeam.score / maxPoints) * 100}%`;
                document.getElementById('homeFoulsBar').style.width =
                    `${(data.homeTeam.fouls / maxFouls) * 100}%`;
                document.getElementById('homeShotsAttemptsBar').style.width =
                    `${(data.homeTeam.statistics?.shots?.attempts / maxShots) * 100}%`;
            }

            if (data.awayTeam) {
                document.getElementById('awayPointsBar').style.width =
                    `${(data.awayTeam.score / maxPoints) * 100}%`;
                document.getElementById('awayFoulsBar').style.width =
                    `${(data.awayTeam.fouls / maxFouls) * 100}%`;
                document.getElementById('awayShotsAttemptsBar').style.width =
                    `${(data.awayTeam.statistics?.shots?.attempts / maxShots) * 100}%`;
            }
        }

        // 更新事件统计
        function updateEventStats(events) {
            const total = events.length;
            const scores = events.filter(e => e.eventType.includes('score')).length;
            const fouls = events.filter(e => e.eventType === 'foul').length;
            const others = total - scores - fouls;

            document.getElementById('totalEvents').textContent = total;
            document.getElementById('scoreEvents').textContent = scores;
            document.getElementById('foulEvents').textContent = fouls;
            document.getElementById('otherEvents').textContent = others;
        }

        // 更新排行榜
        async function updateLeaderboard() {
            try {
                const response = await fetch('/api/statistics/leaderboard');
                const data = await response.json();
                if (data.success) {
                    displayLeaderboard(data.data);
                }
            } catch (error) {
                console.error('加载排行榜失败:', error);
            }
        }

        function displayLeaderboard(players) {
            const leaderboard = document.getElementById('leaderboard');
            if (!players || players.length === 0) {
                leaderboard.innerHTML = '<div class="no-data">暂无数据</div>';
                return;
            }

            // 根据当前标签排序
            const sortedPlayers = [...players].sort((a, b) => {
                if (currentTab === 'points') return (b.statistics?.points || 0) - (a.statistics?.points || 0);
                if (currentTab === 'fouls') return (b.statistics?.fouls || 0) - (a.statistics?.fouls || 0);
                if (currentTab === 'shots') return (b.statistics?.shots?.attempts || 0) - (a.statistics?.shots?.attempts || 0);
                return 0;
            }).slice(0, 10);

            leaderboard.innerHTML = sortedPlayers.map((player, index) => {
                const value = player.statistics?.[currentTab] || 0;
                const statLabel = currentTab === 'shots' ? '投篮' :
                                  currentTab === 'fouls' ? '犯规' : '得分';
                const teamBadge = player.team === 'home' ? 'home' : 'away';
                const teamName = player.team === 'home' ? '主队' : '客队';

                return `
                    <div class="player-item">
                        <div class="rank">${index + 1}</div>
                        <div class="player-info">
                            <div class="player-name">${player.name || '未知'}</div>
                            <div class="player-team badge ${teamBadge}">${teamName}</div>
                            <div class="player-number">#${player.number || '-'}</div>
                        </div>
                        <div class="player-stat">
                            <div class="stat-label">${statLabel}</div>
                            <div class="stat-value">${value}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 初始化加载
        updateLeaderboard();
    </script>
</body>
</html>
